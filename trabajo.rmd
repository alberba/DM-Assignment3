---
title: "Assignment 3"
author: "Santiago Rattenbach, Angel Jiménez, Albert Salom"
date: "21/11/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Libraries}
library(ggplot2)
```


```{r}
data <- read.csv("./loan_data.csv", header=TRUE, stringsAsFactors=TRUE)
str(data)
```

As we can see, the dataset contains 45,000 observations and 14 variables. The variables are as follows:

1. person age: Age of the person (numeric)
2. person gender: Gender of the person (categorical: female, male)
3. person education: Highest education level (categorical: Associate, Bachelor, Doctorate, High School, Master)
4. person income: Annual income (numeric)
5. person emp exp: Years of employment experience (integer)
6. person home ownership: Home ownership status (categorical: MORTGAGE, OTHER, OWN, RENT)
7. loan amnt: Loan amount requested (numeric)
8. loan intent: Purpose of the loan (categorical: DEBTCONSOLIDATION, EDUCATION, HOME-IMPROVEMENT, MEDICAL, PERSONAL, VENTURE)
9. loan int rate: Loan interest rate (numeric)
10. loan percent income: Loan amount as a percentage of annual income (numeric)
11. cb person cred hist length: Length of credit history in years (numeric)
12. credit score: Credit score of the person (integer)
13. previous loan defaults on file: Indicator of previous loan defaults (categorical: No, Yes)


## The Data

### Target Variable

```{r}
# Contar los valores de 'loan_status'
counts <- table(data$loan_status)

# Crear el gráfico de barras
ggplot(data, aes(x = factor(loan_status, labels = c("Rechazado", "Aprobado")))) +
  geom_bar(fill = "skyblue") +
  labs(title = "Distribución del estado de aprobación del préstamo",
       x = "Estado del Préstamo",
       y = "Cantidad")
```

### Independent Variables

Antes de comenzar con el entrenamiento, es importante analizar cada una de las variables independientes para entender sus valores, su distribución y relación con la variable objetivo.

```{r}
summary(data)
```




#### Numerical

- person_age: Este dataset abarca personas adultas, por tanto la edad mínima es 20 años. La media está entre los 27.76 años, por tanto la mayor parte de muestras del conjunto está formada por gente joven. Por otro lado, la edad máxima es 144 años, lo cual es un valor atípico. En este caso, hemos considerado que la edad máxima aceptable es 122 años, ya que es la edad más longeva registrada en la historia. 
Por tanto, eliminaremos las observaciones con edades superiores a 122 años.
- person_income: Este dataset abarca entre valores anuales de 8.000$ y 7.200.766$. Este máximo podría ser un valor atípico, ya que la media de los ingresos anuales es de 66.072$.
- person_emp_exp: Esta variable tiene un rango de 0 a 123 años. Este último valor es bastante atípico, además considerando que la edad máxima que hemos aceptado es de 122 años. 
Igualmente, al eliminar las observaciones con edades superiores a 122 años, también eliminamos las observaciones con años de experiencia laboral superiores a 122 años.


```{r}
data <- subset(data, person_age <= 122)

```

```{r}
# Lista de variables numéricas
numerical_vars <- c('person_age', 'person_income', 'person_emp_exp', 'loan_amnt', 
                    'loan_int_rate', 'loan_percent_income', 
                    'cb_person_cred_hist_length', 'credit_score')


# Distribuciones de las variables numéricas:
for (var in numerical_vars) {
  print(
    ggplot(df, aes_string(x = var)) +
      geom_histogram(fill = "lightblue", color = "white", bins = 30) + 
      geom_density(aes(y = ..density.. * length(df[[var]])), color = "red", size = 1) + 
      labs(title = paste("Distribución de", var), x = var, y = "Frecuencia") +
      theme_minimal()
  )
}
```

#### Categorical

```{r}
table(data$person_gender)
table(data$person_education)
table(data$person_home_ownership)
table(data$person_loan_intent)
table(data$person_previous_loan_defaults)
```

- gender: As we can see, the majority of the applicants are male, however, the difference is not very significant so there isn't much information to be gained from these values.
- education: The number of applicants with a master's degree is approximately half the number of people in any category, except for those with a doctorate, who are significantly fewer. This variable may be useful in predicting the loan status.
- home ownership: The majority of applicants are renters, followed mortgage holders. There are few applicants who own their homes and even fewer who own other types of homes. This variable may also be useful in predicting the loan status.
- loan intent: The most common loan intents are both education and medical bills, followed by debt consolidation, venture and personal loans. Fewer people take out loans for home improvement. This variable may also be useful in predicting the loan status.

### Missing Value Analysis

To find missing values in the dataset, we can use the `is.na()` function in R. 

```{r}
colSums(is.na(data))


summary(data$yrs.since.phd)
summary(data$yrs.service)
summary(data$salary)
```

Como podemos ver, en ninguna de las variables hay valores faltantes, lo que nos hace ahorrarnos el paso de tener que tratar estos valores



#### Target variable

- **loan_status**: The status of the loan (integer 1 = approved; 0 = rejected)

```{r}
library(ggplot2)
ggplot(data, aes(x=loan_status)) + 
  geom_bar(fill="blue") + 
  labs(title="Loan Status Distribution", x="Loan Status", y="Count")
```

```{r}
# Check for missing values
sum(is.na(data))

# Visualize the distribution of loan amounts
hist(data$loan_amnt, main="Distribution of Loan Amounts", xlab="Loan Amount", breaks=50)

# Boxplot of loan amounts by grade
boxplot(loan_amnt ~ grade, data=data, main="Loan Amounts by Grade", xlab="Grade", ylab="Loan Amount")

# Correlation matrix
cor_matrix <- cor(data[, sapply(data, is.numeric)])
corrplot::corrplot(cor_matrix, method="circle")
```


